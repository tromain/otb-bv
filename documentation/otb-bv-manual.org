#+TITLE: Biophysical variable estimation from remote sensing imagery 

* Introduction

* Use
** Input variable generation
*** Variable statistics
|        | Variable         | Minimum | Maximum |   Mode |    Std | Nb_Class | Law   | LAI_Conv |
|--------+------------------+---------+---------+--------+--------+----------+-------+----------|
| Canopy | MLAI             |     0.0 |     8.0 |    2.0 |    2.0 |        6 | gauss |     1000 |
|        | ALA (°)          |      30 |      80 |     60 |     20 |        3 | gauss |       10 |
|        | Crown_Cover      |     1.0 |     1.0 |    0.8 |    0.4 |        1 | uni   |       10 |
|        | HsD              |     0.1 |     0.5 |    0.2 |    0.5 |        1 | gauss |     1000 |
|--------+------------------+---------+---------+--------+--------+----------+-------+----------|
| Leaf   | N                |    1.20 |    1.80 |   1.50 |   0.30 |        3 | gauss |       10 |
|        | Cab (\mu g.m -2) |      20 |      90 |     45 |     30 |        4 | gauss |       10 |
|        | Cdm (g.m-2)      |  0.0030 |  0.0110 | 0.0050 | 0.0050 |        4 | gauss |       10 |
|        | Cw_Rel           |    0.60 |    0.85 |   0.75 |   0.08 |        4 | uni   |       10 |
|        | Cbp              |    0.00 |    2.00 |   0.00 |   0.30 |        3 | gauss |       10 |
|--------+------------------+---------+---------+--------+--------+----------+-------+----------|
| Soil   | Bs               |    0.50 |    3.50 |   1.20 |   2.00 |        4 | gauss |       10 |


**** Prospect OTB
| Nom var OTB      | Description             | var bvnet  |
|------------------+-------------------------+------------|
| double m_Cab;    | //Chlorophyll content   | Cab        |
| double m_Car;    | //Carotenoid content    |            |
| double m_CBrown; | //Brown pigment content | Cbp        |
| double m_Cw;     | //EWT                   | Cw_Rel (?) |
| double m_Cm;     | //LMA                   | Cdm (?)    |
| double m_N;      | //structure coef        | N          |

Cw = Cdm *Cw_Rel/(1-Cw_Rel)
Cdm = Cm
Crown_Cover = not used in SAIL, only useful if GEOSAIL
Car --> not used by bvnet; Féret's dissertation uses Cxc to denote Car
and gives a mean of 8.58 and a std of 3.95 and fig 2.2, p.47 gives the
min at 0 and the max at 25



**** Sail OTB
| Nom var OTB     | Description                | var bvnet                  |
|-----------------+----------------------------+----------------------------|
| double m_LAI;   | //leaf area index          | MLAI                       |
| double m_Angl;  | //average leaf angle       | ALA                        |
| double m_PSoil; | //soil coefficient         | utilise un spectre complet |
| double m_Skyl;  | //diffuse/direct radiation |                            |
| double m_HSpot; | //hot spot                 | HsD                        |
| double m_TTS;   | //solar zenith angle       | \theta_s                   |
| double m_TTO;   | //observer zenith angle    | \theta_v                   |
| double m_PSI;   | //azimuth                  | \psi                       |

Skyl = 0
Bs --> l'utiliser pour multiplier la réflectance du sol

*** Variable correlations
*** Results
#+name: sample-file
: /tmp/samples.txt

#+name: figure-file 
: scatter.png

#+name: numsamples
: 1000


#+begin_src sh :var outfile=sample-file :var samples:numsamples
otbcli_BVInputVariableGeneration -samples $samples -out $outfile
head $outfile
#+end_src

#+RESULTS:
|   MLAI |   ALA | CrownCover |    HsD |     N |   Cab |      Cdm |  CwRel |     Cbp |     Bs |
| 0.5609 | 55.93 |      1.092 |  0.142 | 1.476 | 85.26 | 0.004603 | 0.7356 |  0.4354 | 0.6643 |
|  3.851 | 56.38 |     0.5589 | 0.4101 | 1.683 | 52.17 | 0.004771 | 0.7853 |  0.1626 |  2.249 |
|  3.184 | 51.55 |     0.8362 | 0.4839 | 1.688 | 35.33 | 0.004139 | 0.7008 | 0.02641 |  2.375 |
|  3.412 | 46.72 |     0.9799 | 0.4665 |  1.34 |  36.1 | 0.005933 | 0.6999 |  0.0356 |  2.327 |
|  2.361 | 66.96 |     0.8618 | 0.3604 | 1.653 | 48.75 | 0.005816 | 0.7803 |   0.242 |  1.571 |
|   3.58 | 67.54 |     0.9746 | 0.4488 | 1.631 | 45.95 | 0.004078 | 0.7679 |  0.2375 |  2.084 |
|  3.566 | 45.79 |     0.6626 | 0.2087 | 1.405 | 63.07 | 0.004747 | 0.8075 |  0.3232 |  1.267 |
|  2.955 | 57.72 |     0.6685 |   0.26 | 1.593 | 36.52 | 0.008179 | 0.7556 |  0.4647 |  2.805 |
|  3.524 | 63.58 |     0.6787 | 0.1097 | 1.522 | 60.61 | 0.006968 | 0.7773 |  0.1248 |  2.014 |

#+begin_src sh :var outfile=sample-file figfile=figure-file
python ../src/scripts/scatterplots.py $outfile $figfile
#+end_src

[[file:scatter.png]]


** Reflectance simulation

*** Soil in Sail OTB
./otbSailModel.cxx:280:      Rsoil1 = DataSpecP5B[i].drySoil; //10
./otbSailModel.cxx:281:      Rsoil2 = DataSpecP5B[i].wetSoil; //11
rsoil0 = m_PSoil*Rsoil1+(1-m_PSoil)*Rsoil2;
** Mismatch estimation

** Model inversion

** BV estimation

* References

* Actions                                                          :noexport:

** TODO References Weiss & Baret
** TODO [2013-10-24 Thu 14:36] Comments  [[file:~/Dev/otb-bv/src/library/otbNeuralNetworkRegressionMachineLearningModel.h::void%20SetLayerSizes%20(const%20std::vector<unsigned%20int>%20layers)][file:~/Dev/otb-bv/src/library/otbNeuralNetworkRegressionMachineLearningModel.h::void SetLayerSizes (const std::vector<unsigned int> layers)]]
- SetLayerSizes should be virtual
- attributers shoudl be protected and not private
** TODO [2013-10-24 Thu 14:41] variables are not normalised in the regression
  [[file:~/Dev/otb-bv/src/library/otbNeuralNetworkRegressionMachineLearningModel.h::/**]]
** TODO Implement a version of Sail which uses an external soil file
** TODO Validation
*** [2013-11-29 Fri 15:48] Pour extraire les simulations bvnet de matlab

load 20130822_F2_inout.mat
fieldnames(Law)

pour écrire un fichier avec toutes les valeurs pour une simulation

     fid = fopen ("myfile.txt", "w");
     fdisp (fid, "3/8 is ");
     fdisp (fid, 3/8);
     fclose (fid);
*** Description des données préparées par David
**** Simulation des Variables biophysiques :
 - LAI, N, ALA, etc. 
   - caractéristiques pour la simulation dans \Workspace\20130822_F2_Canopy_Atmos_Class_1.csv
   - simulations dans le fichier matlab \Workspace\Report_20130822_F2\Class_1\20130822_F2_inout.mat , structure "Law"
     - /home/inglada/stok/DATA/BVNET_otb/Workspace/Report_20130822_F2/Class_1/20130822_F2_inout.mat
   - les caractéristiques du sol nu dans les configurations sont couplées avec une série de courbes sol nu, ici est utilisé \DATA\Soil\R_Soil_ISRIC_7soils.mat
 - Géométrie de prise de vue :
   - Workspace\20130822_F2_Configuration.csv

**** Réflectance simulée :
- \Workspace\Report_20130822_F2\Class_1\20130822_F2_inout.mat , structure Input > Rho_Toc > valeurs pour chaque bande
**** Image d'entrée :
- \Workspace\20130822_F2 + .hdr. Le modèle prend du format ENVI (géoréférencé ou non) en entrée, j'ai aussi mis un format GeoTiff géoréférencé.
- les caractéristiques utilisées comme référence pour les capteurs sont dans \DATA\Filtres_Smac.mat
**** Variables estimées par BVNET :
- \Workspace\Report_20130822_F2\Class_1\20130822_F2_inout.mat , structure "Output". 
- Les images en sortie sont dans le dossier \Workspace\Image_20130822_F2\ sous format ENVI non géoréférencé.

**** Les deux programmes centraux sont :
- Build_Learn.m (construction du réseau de neurones)
- \CODE\Apply_NNT\Macro_Apply_NNT.m (application à l'image d'entrée)

**** Code pour parser le fichier
#+begin_src octave
load \
/home/inglada/stok/DATA/BVNET_otb/Workspace/Report_20130822_F2/Class_1/20130822_F2_inout.mat

nbSamples = size(Law.I_Soil)(1)  
fid = fopen ("law.txt", "w");
fdisp (fid, "IS\t LAI\t ALA\t CC\t HsD\t N\t Cab\t Cdm\t Cw_Rel\t \
Cbp\t Bs\t VZ\t VAz\t SZ\t SA\t B1\t B2\t B3\t FCOV\t FAP\t LAI\t")
       
for i = 1:nbSamples
  fprintf(fid, "%.3f \t", Law.I_Soil(i))
  fprintf(fid, "%.3f \t", Law.LAI(i))
  fprintf(fid, "%.3f \t", Law.ALA(i))
  fprintf(fid, "%.3f \t", Law.Crown_Cover(i))
  fprintf(fid, "%.3f \t", Law.HsD(i))
  fprintf(fid, "%.3f \t", Law.N(i))
  fprintf(fid, "%.3f \t", Law.Cab(i))
  fprintf(fid, "%.3f \t", Law.Cdm(i))
  fprintf(fid, "%.3f \t", Law.Cw_Rel(i))
  fprintf(fid, "%.3f \t", Law.Cbp(i))
  fprintf(fid, "%.3f \t", Law.Bs(i))
  fprintf(fid, "%.3f \t", Law.View_Zenith(i))
  fprintf(fid, "%.3f \t", Law.View_Azimuth(i))
  fprintf(fid, "%.3f \t", Law.Sun_Zenith(i))
  fprintf(fid, "%.3f \t", Law.Sun_Azimuth(i))
  fprintf(fid, "%.3f \t", Input.Rho_Toc(i,1))
  fprintf(fid, "%.3f \t", Input.Rho_Toc(i,2))
  fprintf(fid, "%.3f \t", Input.Rho_Toc(i,3))
  fprintf(fid, "%.3f \t", Output.FCOVER(i))
  fprintf(fid, "%.3f \t", Output.FAPAR(i))
  fprintf(fid, "%.3f \n", Output.LAI(i))
endfor

fclose (fid);
#+end_src

**** Fichier avec les données
[[file:~/stok/DATA/BVNET_otb/Workspace/Report_20130822_F2/Class_1/law.txt]]

#+begin_src sh
head ~/stok/DATA/BVNET_otb/Workspace/Report_20130822_F2/Class_1/law.txt
#+end_src

#+RESULTS:
|  IS |   LAI |    ALA |    CC |   HsD |     N |    Cab |   Cdm | Cw_Rel |   Cbp |    Bs |    VZ |   VAz |    SZ |    SA |    B1 |    B2 |    B3 |  FCOV |   FAP |   LAI |
| 7.0 | 3.728 | 59.755 | 0.958 | 0.186 | 1.494 | 64.632 | 0.008 |  0.733 | 0.075 | 0.729 | 0.305 | 5.023 | 0.647 | 2.428 | 0.046 | 0.032 | 0.406 | 0.792 | 0.863 | 3.728 |
| 5.0 | 2.971 | 29.822 | 0.963 | 0.311 | 1.385 | 72.532 | 0.005 |   0.67 | 0.372 | 0.613 | 0.305 | 5.023 | 0.647 | 2.428 | 0.059 |  0.04 |  0.51 | 0.872 | 0.867 | 2.971 |
| 7.0 |  0.64 | 11.959 | 0.985 | 0.431 | 1.463 | 44.276 | 0.005 |   0.82 | 0.417 | 0.444 | 0.305 | 5.023 | 0.647 | 2.428 | 0.086 | 0.077 | 0.318 | 0.442 | 0.431 |  0.64 |
| 7.0 | 0.798 | 48.686 | 0.985 | 0.259 | 1.785 | 36.291 | 0.008 |  0.716 | 0.214 | 0.588 | 0.305 | 5.023 | 0.647 | 2.428 | 0.099 | 0.096 | 0.299 | 0.376 | 0.418 | 0.798 |
| 7.0 | 4.599 | 44.403 | 0.966 | 0.473 | 1.758 | 55.954 | 0.006 |  0.658 | 0.018 |  0.55 | 0.305 | 5.023 | 0.647 | 2.428 | 0.092 | 0.049 | 0.609 | 0.919 | 0.901 | 4.599 |
| 7.0 | 2.102 | 46.606 | 0.959 | 0.318 | 1.399 | 29.591 | 0.004 |  0.803 | 0.197 |  0.63 | 0.305 | 5.023 | 0.647 | 2.428 | 0.098 | 0.066 | 0.429 | 0.701 | 0.714 | 2.102 |
| 3.0 | 4.549 | 50.386 | 0.982 | 0.442 | 1.873 | 65.192 | 0.009 |  0.738 | 0.239 | 0.458 | 0.305 | 5.023 | 0.647 | 2.428 | 0.066 | 0.038 | 0.491 | 0.917 | 0.917 | 4.549 |
| 5.0 | 0.443 | 57.212 | 0.981 | 0.119 | 2.009 | 30.125 |  0.01 |  0.811 | 0.369 | 0.693 | 0.305 | 5.023 | 0.647 | 2.428 | 0.107 | 0.131 | 0.254 | 0.186 | 0.244 | 0.443 |
| 7.0 | 0.706 | 33.199 | 0.973 | 0.131 | 1.647 | 84.235 | 0.011 |  0.831 | 0.083 | 0.553 | 0.305 | 5.023 | 0.647 | 2.428 | 0.075 | 0.077 | 0.307 | 0.395 | 0.441 | 0.706 |


***** Input vars
[[file:~/stok/DATA/BVNET_otb/Workspace/Report_20130822_F2/Class_1/input-vars.txt]]

#+begin_src sh
head ~/stok/DATA/BVNET_otb/Workspace/Report_20130822_F2/Class_1/input-vars.txt
#+end_src

#+RESULTS:
|   LAI |    ALA |    CC |   HsD |     N |    Cab |   Cdm | Cw_Rel |   Cbp |    Bs |
| 3.728 | 59.755 | 0.958 | 0.186 | 1.494 | 64.632 | 0.008 |  0.733 | 0.075 | 0.729 |
| 2.971 | 29.822 | 0.963 | 0.311 | 1.385 | 72.532 | 0.005 |   0.67 | 0.372 | 0.613 |
|  0.64 | 11.959 | 0.985 | 0.431 | 1.463 | 44.276 | 0.005 |   0.82 | 0.417 | 0.444 |
| 0.798 | 48.686 | 0.985 | 0.259 | 1.785 | 36.291 | 0.008 |  0.716 | 0.214 | 0.588 |
| 4.599 | 44.403 | 0.966 | 0.473 | 1.758 | 55.954 | 0.006 |  0.658 | 0.018 |  0.55 |
| 2.102 | 46.606 | 0.959 | 0.318 | 1.399 | 29.591 | 0.004 |  0.803 | 0.197 |  0.63 |
| 4.549 | 50.386 | 0.982 | 0.442 | 1.873 | 65.192 | 0.009 |  0.738 | 0.239 | 0.458 |
| 0.443 | 57.212 | 0.981 | 0.119 | 2.009 | 30.125 |  0.01 |  0.811 | 0.369 | 0.693 |
| 0.706 | 33.199 | 0.973 | 0.131 | 1.647 | 84.235 | 0.011 |  0.831 | 0.083 | 0.553 |

***** Output refls
[[file:~/stok/DATA/BVNET_otb/Workspace/Report_20130822_F2/Class_1/output-refls.txt]]
#+begin_src sh
head ~/stok/DATA/BVNET_otb/Workspace/Report_20130822_F2/Class_1/output-refls.txt
#+end_src

#+RESULTS:
|    B1 |    B2 |    B3 |
| 0.046 | 0.032 | 0.406 |
| 0.059 |  0.04 |  0.51 |
| 0.086 | 0.077 | 0.318 |
| 0.099 | 0.096 | 0.299 |
| 0.092 | 0.049 | 0.609 |
| 0.098 | 0.066 | 0.429 |
| 0.066 | 0.038 | 0.491 |
| 0.107 | 0.131 | 0.254 |
| 0.075 | 0.077 | 0.307 |

***** Simulations
#+begin_src sh
otbcli_ProSailSimulator -bvfile ~/stok/DATA/BVNET_otb/Workspace/Report_20130822_F2/Class_1/input-vars.txt \
    -soilfile soil.txt -rsrfile ~/Dev/otb-bv/data/formosat2.rsr -out /tmp/simus.txt \
    -solarzenith 37.08 -sensorzenith 17.48 -azimuth 149.159
#+end_src

(* 180.0 (/ (- 5.03 2.428) 3.14))

#+begin_src sh
head /tmp/simus.txt
#+end_src

#+RESULTS:
| 0.00812213 |  0.0074936 | 0.00731742 | 0.0103929 | 0.00981358 |
|  0.0115862 |   0.010452 |  0.0104512 | 0.0140087 |  0.0135353 |
|  0.0303241 |  0.0354416 |  0.0393449 | 0.0487835 |   0.046169 |
|  0.0313329 |  0.0381138 |  0.0419052 | 0.0530174 |  0.0497086 |
| 0.00996737 | 0.00949007 | 0.00880305 | 0.0138654 |  0.0126334 |
|  0.0121105 |  0.0121685 |  0.0124179 |  0.015252 |  0.0151401 |
| 0.00921148 | 0.00862345 | 0.00811449 | 0.0122571 |  0.0113622 |
|  0.0565182 |  0.0713378 |  0.0803616 | 0.0977797 |  0.0925198 |
|  0.0325505 |  0.0386697 |  0.0432387 | 0.0537301 |  0.0506309 |
|  0.0199048 |  0.0229026 |  0.0250312 |  0.031949 |  0.0300118 |





